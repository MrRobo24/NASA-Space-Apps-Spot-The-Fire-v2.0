<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fyre</title>
    <link rel="stylesheet" type="text/css" href="styles/inline.css">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon"/>
    <link rel="manifest" href="manifest.json">
</head>
<body>
<div id="bubble">
    <div>
        <h3 class="title" id="title">NEWS</h3>
        <h3 class="title2" id="title2">4:20pm</h3>
    </div>
    <div id="scrollable_bubble"></div>
</div>
<main class="main">
    <div id="crosshair">+</div>
    <div id="googleMap" style="width:100%;height:100%;"></div>

    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC24s5UrWB7uiAPHImehxTb-5kaidfpZpk&libraries=visualization"></script>

    <script>
        /* Data points defined as a mixture of WeightedLocation and LatLng objects */
        var heatMapData = [
            {location: new google.maps.LatLng(37.782, -122.447), weight: 0.5},
            new google.maps.LatLng(37.782, -122.445),
            {location: new google.maps.LatLng(37.782, -122.443), weight: 2},
            {location: new google.maps.LatLng(37.782, -122.441), weight: 3},
            {location: new google.maps.LatLng(37.782, -122.439), weight: 2},
            new google.maps.LatLng(37.782, -122.437),
            {location: new google.maps.LatLng(37.782, -122.435), weight: 0.5},

            {location: new google.maps.LatLng(37.785, -122.447), weight: 3},
            {location: new google.maps.LatLng(37.785, -122.445), weight: 2},
            new google.maps.LatLng(37.785, -122.443),
            {location: new google.maps.LatLng(37.785, -122.441), weight: 0.5},
            new google.maps.LatLng(37.785, -122.439),
            {location: new google.maps.LatLng(37.785, -122.437), weight: 2},
            {location: new google.maps.LatLng(37.785, -122.435), weight: 3}
        ];

        var sanFrancisco = new google.maps.LatLng(37.774546, -122.433523);

        map = new google.maps.Map(document.getElementById('googleMap'), {
            center: sanFrancisco,
            zoom: 13,
            mapTypeId: 'satellite',
            zoomControl: false,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false
        });

        heatmap = new google.maps.visualization.HeatmapLayer({
            data: heatMapData,
            dissipating: false
        });
        heatmap.setMap(map);

        function addHeatMapData() {
            //
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    heatmap_data = JSON.parse(xhttp.responseText);
                    heatmap_data_object = [];
                    for (let key in heatmap_data) {
                        datum = heatmap_data[key];
                        heatmap_data_object.push({
                            location: new google.maps.LatLng(datum[0], datum[1]),
                            weight: datum[2]
                        })
                    }
                    heatmap.setOptions({data: heatmap_data_object});
                    console.log(heatmap_data)
                }
            };
            xhttp.open("GET", "/api/fire_data", true);
            xhttp.send();
        }
    </script>


    <div id="addDialogContainer">
        <div class="dialog">
            <div class="dialog-title">Add new city</div>
            <div class="dialog-body">
                <select id="selectCityToAdd" aria-label="City to add">
                    <!--
                      Values are lat/lon values, use Google Maps to find and add
                      additional cities.
                    -->
                    <option value="28.6472799,76.8130727">Dehli, India</option>
                    <option value="-5.7759362,106.1174957">Jakarta, Indonesia</option>
                    <option value="51.5287718,-0.2416815">London, UK</option>
                    <option value="40.6976701,-74.2598666">New York, USA</option>
                    <option value="48.8589507,2.2770202">Paris, France</option>
                    <option value="-64.8251018,-63.496847">Port Lockroy, Antarctica</option>
                    <option value="37.757815,-122.5076401">San Francisco, USA</option>
                    <option value="31.2243085,120.9162955">Shanghai, China</option>
                    <option value="35.6735408,139.5703032">Tokyo, Japan</option>
                </select>
            </div>
            <div class="dialog-buttons">
                <button id="butDialogCancel" class="button">Cancel</button>
                <button id="butDialogAdd" class="button">Add</button>
            </div>
        </div>
    </div>

    <div id="buttons">
        <div class="button_group bl">
            <div>
                <button class="small_button b1" style="bottom: 20px;" onclick="show_messages()"><img
                        src="images/icons/message.svg" style="width: 18px; height: 18px; margin-top: 10px;"></button>
                <button class="small_button b2" style="bottom: 20px;">B</button>
                <button class="small_button b3" style="bottom: 20px;">C</button>
            </div>
            <button class="big_button" onclick="buttonClick(this)"><img src="images/icons/account-group.svg"
                                                                        style="width: 36px; height: 36px; margin-top: 12px;">
            </button>
        </div>
        <div class="button_group bc">
            <button class="big_button" onclick='openPopupPage("Report fire", "Reporting", "pages/report.html")'><img src="images/icons/fire.svg"
                                                               style="width: 64px; height: 64px; margin-top: 12px;">
            </button>
        </div>
        <div class="button_group br">
            <div>
                <button class="small_button b1" style="bottom: 20px;">A</button>
                <button class="small_button b2" style="bottom: 20px;">B</button>
                <button class="small_button b3" style="bottom: 20px;">C</button>
            </div>
            <button class="big_button" onclick="buttonClick(this)">+</button>
        </div>
    </div>

    <script>
        function buttonClick(e) {
            bg = e.parentElement;
            console.log(bg)
            sbs = bg.children[0].children;
            if (sbs[0].style.bottom === "") {
                for (key in sbs) {
                    sbs[key].style.bottom = "20px";
                }
            } else {
                for (key in sbs) {
                    sbs[key].style.bottom = "";
                }
            }
        }

        function openPopup(title, title2, html) {
            document.getElementById("title").innerHTML = title;
            document.getElementById("title2").innerHTML = title2;
            document.getElementById("bubble").style.height = "calc(100vh - 40px)";
            document.getElementById("scrollable_bubble").innerHTML = html;
        }

        function close_popup() {
            openPopup("NEWS", "4:20pm", "")
            document.getElementById("bubble").style.height = "";
        }

        function message_html(name, last_message, time, img_path) {
            return "<span class='message'><img src='" + img_path + "'><h3>" + name + "</h3><h3 class='title2'>" + time + "</h3><br><p>" + last_message + "</p><br><hr></span>"
        }

        function show_messages() {
            messages_html = "";
            for (i = 0; i < 30; i++) {
                messages_html += message_html("Jimmy Bob", "I live at 50 Colburn Close if...", "4:20pm", "images/testprofilepic.png")
            }
            openPopup("Direct messages", "Richard Slaney", messages_html)
            history.pushState({"name": "messages", "data": messages_html}, null, "#messages")
        }

        function report() {
            openPopup("Send report", "Reporting", "<form><input id=\"fireimage\" name=\"fireimage\" type=\"file\" accept=\"image/*;capture=camera\" style='opacity: 0; position: absolute; width: 0.1px'><label for='fireimage' id='uploadfile'>Upload image</label><span id='fireimagetext'></span></form>")
            document.getElementById("fireimage").addEventListener("change", function (e) {
                document.getElementById("fireimagetext").innerHTML = "File: " + e.target.files[0]["name"];
            })
        }

        function openPopupPage(title, title2, pagepath) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    // Typical action to be performed when the document is ready:
                    history.pushState({"name": "title", "data": xhttp.responseText}, null, "#" + title)
                    openPopup(title, title2, xhttp.responseText);
                }
            };
            xhttp.open("GET", pagepath, true);
            xhttp.send();
        }

        history.replaceState({"name": "home"}, null, "#home")

        window.onpopstate = function (event) {
            console.log(event.state);
            if (event.state["name"] === "home") {
                close_popup()
            }
        };

        function populateFormPositionGPS(position) {
            console.log(position)
            document.getElementById("lat").value = position.coords.latitude;
            document.getElementById("lng").value = position.coords.longitude;
        }

        function populateFormPositionMap() {
            position = map.getCenter();
            document.getElementById("lat").value = position.lat();
            document.getElementById("lng").value = position.lng();
        }

        function submitReport() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    openPopup("Report uploaded!", "Reporting", "<p>Your report has been uploaded, thank you for your help.</p>");
                }
            };
            xhr.open('POST', '/uploadreport', true);
            var formData = new FormData();
            formData.append("file", document.getElementById("fireimage").files[0]);
            formData.append("lat", document.getElementById("lat").value);
            formData.append("lng", document.getElementById("lng").value);
            formData.append("reportdescription", document.getElementById("reportdescription").value);
            xhr.send(formData); // Simple!
        }
    </script>

    <script src="scripts/luxon-1.11.4.js"></script>
    <script src="scripts/app.js"></script>
</body>
</html>
